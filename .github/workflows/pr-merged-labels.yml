name: PR Merged Labels (Reusable)

on:
  workflow_call:
    inputs:
      # Event context (must be passed by caller)
      pr_merged:
        description: 'Whether the PR was merged (true/false)'
        required: true
        type: boolean
      pr_body:
        description: 'PR body text'
        required: false
        type: string
        default: ''
      pr_number:
        description: 'PR number'
        required: true
        type: string

jobs:
  label-connected-issues:
    if: inputs.pr_merged == true
    runs-on: ubuntu-latest

    permissions:
      issues: write
      pull-requests: read

    steps:
      - name: Add released label to connected issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ inputs.pr_body }}
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          REPO="${{ github.repository }}"

          echo "Processing merged PR #${PR_NUMBER}"

          ISSUES=$(echo "$PR_BODY" | grep -oEi '(close[sd]?|fix(es|ed)?|resolve[sd]?)\s*#([0-9]+)' | grep -oE '[0-9]+' || true)

          if [ -z "$ISSUES" ]; then
            echo "No connected issues found in PR body"
            exit 0
          fi

          echo "Found connected issues: $ISSUES"

          for ISSUE_NUM in $ISSUES; do
            echo "Adding 'released' label to issue #${ISSUE_NUM}"
            gh issue edit "$ISSUE_NUM" --add-label "released" --repo "$REPO" 2>/dev/null || echo "Could not add label to issue #${ISSUE_NUM}"
          done

          echo "Done processing connected issues"
